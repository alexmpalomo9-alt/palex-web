<div class="tables-container mat-elevation-z2" [class.dark-theme]="isDarkMode">
  <!-- HEADER CON SECTION-HEADER -->
  <app-section-header
    icon="table_restaurant"
    title="Mesas del Restaurante"
    subtitle="Administra las mesas, estados y pedidos activos."
    filterPlaceholder="Buscar mesas:"
    (search)="onSearch($event)"
  >
    <app-add-button
      label="Crear Mesa"
      icon="add"
      (onClick)="openCreateTable()"
    ></app-add-button>
  </app-section-header>

  <!-- LOADING -->
  <mat-progress-bar
    *ngIf="loading"
    mode="indeterminate"
    class="loading-bar"
  ></mat-progress-bar>

  <!-- TABLA -->
  <div class="table-wrapper">
    <table mat-table [dataSource]="filteredTables" class="mat-table">
      <!-- Nº -->
      <ng-container matColumnDef="number">
        <th mat-header-cell *matHeaderCellDef>Nº</th>
        <td mat-cell *matCellDef="let t">{{ t.number }}</td>
      </ng-container>

      <!-- Nombre -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nombre</th>
        <td mat-cell *matCellDef="let t">{{ t.name || "-" }}</td>
      </ng-container>

      <!-- Capacidad -->
      <ng-container matColumnDef="capacity">
        <th mat-header-cell *matHeaderCellDef>Cap.</th>
        <td mat-cell *matCellDef="let t">{{ t.capacity }}</td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let t">
          <!-- Mostrar el estado de la mesa -->
          <span class="badge" [style.backgroundColor]="getTableStatusColor(t)">
            {{ getTableStatusLabel(t) }}
          </span>

          <!-- Si hay un pedido, también mostrar el estado del pedido -->
          <div *ngIf="t.currentOrderId">
            <span
              class="badge"
              [style.backgroundColor]="getOrderStatusColor(t)"
            >
              {{ getOrderStatusLabel(t) }}
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Sector -->
      <ng-container matColumnDef="sector">
        <th mat-header-cell *matHeaderCellDef>Sector</th>
        <td mat-cell *matCellDef="let t">{{ t.sector }}</td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let t" class="actions-cell">
          <button mat-icon-button color="primary" (click)="openEditTable(t)">
            <mat-icon>edit</mat-icon>
          </button>

          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>swap_horiz</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="changeStatus(t, 'available')">
              Disponible
            </button>
            <button mat-menu-item (click)="changeStatus(t, 'seated')">
              Cliente esperando
            </button>
            <button mat-menu-item (click)="changeStatus(t, 'occupied')">
              Ocupada
            </button>
            <button mat-menu-item (click)="changeStatus(t, 'reserved')">
              Reservada
            </button>
          </mat-menu>

          <button mat-icon-button color="warn" (click)="deleteTable(t)">
            <mat-icon>delete</mat-icon>
          </button>
          <button mat-icon-button color="accent" (click)="openQr(t)">
            <mat-icon>qr_code</mat-icon>
          </button>

          <button
            mat-icon-button
            color="primary"
            (click)="viewOrder(t.currentOrderId, t)"
          >
            <mat-icon>receipt_long</mat-icon>
            <mat-icon *ngIf="t.currentOrderId" class="active-order-icon"
              >circle</mat-icon
            >
          </button>
        </td>
      </ng-container>

      <!-- Filas -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        [ngClass]="{ 'active-order-row': row.currentOrderId }"
      ></tr>
    </table>
  </div>

  <!-- EMPTY STATE -->
  <div *ngIf="!loading && tables.length === 0" class="empty-state">
    <p>No hay mesas registradas.</p>
  </div>
</div>
