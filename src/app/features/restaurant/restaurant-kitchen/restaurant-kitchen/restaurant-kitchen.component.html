<div class="kitchen-container container-fluid kitchen-mode">
  <ng-container *ngIf="activeOrders$ | async as orders">
    <div class="row" *ngIf="orders.length > 0; else noOrders">
      <div class="col-12 col-md-6 col-lg-4" *ngFor="let order of orders">
        <mat-card class="order-card mat-elevation-z8">
          <!-- HEADER -->
          <mat-card-header
            [ngClass]="{
              'new-order': getStatusLabel(order) === 'Nuevo',
              'updated-order': order.lastUpdateDecision === 'accepted',
              'preparing-order': order.status === 'preparing'
            }"
          >
            <div class="header-left">
              <mat-icon color="primary">restaurant_menu</mat-icon>
              <span class="tables">Mesa(s): {{ order.tableNumbers }}</span>
            </div>

            <div class="header-right">
              <span
                class="status-badge"
                [ngStyle]="{ backgroundColor: getStatusColor(order) }"
              >
                {{ getEffectiveStatus(order) }}
              </span>
            </div>
          </mat-card-header>

          <!-- CONTENT -->
          <mat-card-content>
            <mat-divider class="my-2"></mat-divider>

            <ng-container *ngIf="order.pendingUpdate; else singleView">
              <div class="order-comparison">
                <!-- ACTUAL -->
                <div class="order-column">
                  <h6>Actual</h6>
                  <div class="info-row">
                    <mat-icon>person</mat-icon>
                    <span>{{ order.waiterName }}</span>
                    <mat-icon>payments</mat-icon>
                    <span
                      >Total: <strong>${{ order.total }}</strong></span
                    >
                  </div>
                  <ul class="list-unstyled">
                    <li *ngFor="let item of order.items" class="item-row">
                      <span class="qty">{{ item.qty }}x</span>
                      <span class="name">{{ item.name }}</span>
                      <span class="price">${{ item.subtotal }}</span>
                    </li>
                  </ul>
                  <div class="info-row notes">
                    <mat-icon>notes</mat-icon>
                    <span>{{ order.notes || "Sin notas" }}</span>
                  </div>
                </div>

                <!-- SOLICITADO -->
                <div class="order-column pending">
                  <h6>Cambios Solicitados</h6>
                  <div class="info-row">
                    <mat-icon>person</mat-icon>
                    <span>{{ order.waiterName }}</span>
                  </div>
                  <div class="info-row">
                    <mat-icon>payments</mat-icon>
                    <span
                      >Total:
                      <strong>${{ order.pendingUpdate.total }}</strong></span
                    >
                  </div>
                  <ul class="list-unstyled">
                    <li
                      *ngFor="let item of order.pendingUpdate.items"
                      class="item-row"
                    >
                      <span class="qty">{{ item.qty }}x</span>
                      <span class="name">{{ item.name }}</span>
                      <span class="price">${{ item.subtotal }}</span>
                    </li>
                  </ul>
                  <div class="info-row notes">
                    <mat-icon>notes</mat-icon>
                    <span>{{
                      order.pendingUpdate.notes || "Sin notas nuevas"
                    }}</span>
                  </div>

                  <!-- Botones de actualización dentro de esta columna -->
                  <mat-card-actions class="actions update-actions">
                    <button
                      mat-flat-button
                      color="primary"
                      (click)="acceptUpdate(order)"
                    >
                      <mat-icon>check_circle</mat-icon>
                      Aceptar
                    </button>

                    <button
                      mat-flat-button
                      color="warn"
                      (click)="rejectUpdate(order)"
                    >
                      <mat-icon>cancel</mat-icon>
                      Rechazar
                    </button>
                  </mat-card-actions>
                </div>
              </div>
            </ng-container>

            <!-- VISTA NORMAL -->
            <ng-template #singleView>
              <div class="info-row">
                <mat-icon>person</mat-icon>
                <span>Creado por: {{ order.waiterName }}</span>
              </div>

              <div class="info-row">
                <mat-icon>payments</mat-icon>
                <span
                  >Total: <strong>${{ order.total }}</strong></span
                >
              </div>

              <ul class="list-unstyled">
                <li *ngFor="let item of order.items" class="item-row">
                  <span class="qty">{{ item.qty }}x</span>
                  <span class="name">{{ item.name }}</span>
                  <span class="price">${{ item.subtotal }}</span>
                </li>
              </ul>

              <div class="info-row notes">
                <mat-icon>notes</mat-icon>
                <span>{{ order.notes || "Sin notas" }}</span>
              </div>
            </ng-template>
          </mat-card-content>

          <!-- ACCIONES DE COCINA -->
          <mat-card-actions class="actions">
            <app-add-button
              class="btn-secondary"
              label="En preparación"
              icon="schedule"
              (onClick)="markPreparing(order)"
              [disabled]="isPreparingDisabled(order)"
            ></app-add-button>

            <app-add-button
              class="btn-main"
              label="Listo"
              icon="check_circle"
              (onClick)="markReady(order)"
              [disabled]="isReadyDisabled(order)"
            ></app-add-button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>
  </ng-container>

  <ng-template #noOrders>
    <div class="no-orders-message text-center my-5">
      <mat-icon>restaurant_menu</mat-icon>
      <p class="mt-3">No hay pedidos activos</p>
    </div>
  </ng-template>
</div>
